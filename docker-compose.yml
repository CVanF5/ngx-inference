
services:
  nginx:
    build:
      dockerfile: docker/nginx/Dockerfile
    container_name: ngx-inference-nginx
    ports:
      - "8081:80"
    depends_on:
      - mock-epp
      - echo-server
    volumes:
      - ./docker/nginx/nginx-test.conf:/etc/nginx/nginx.conf:ro

  # Mock External Processor for EPP (Endpoint Picker Processor) listening on :9001
  mock-epp:
    build:
      context: .
      dockerfile: docker/mock-extproc/Dockerfile
    container_name: extproc-epp
    command: ["extproc_mock", "0.0.0.0:9001"]
    environment:
      # The EPP upstream for endpoint selection
      - EPP_UPSTREAM=echo-server:80
      - MOCK_ROLE=EPP

  # Simple upstream service the module should route to based on ext-proc header
  # Using a custom echo server that accepts large payloads (50MB limit)
  echo-server:
    build:
      context: docker/echo-server
    container_name: echo-server
    environment:
      - PORT=80
    # Custom echo server with 50MB body limit
    # No published port needed; nginx routes internally via service name

# All services share the default network allowing DNS resolution by service name.
# Access the stack via:
#   Basic test: curl -i http://localhost:8081/
#   EPP test: curl -i http://localhost:8081/epp-test
#   BBR test: curl -i http://localhost:8081/bbr-test -H 'Content-Type: application/json' --data '{"model":"claude-4","input": "Why is the sky blue"}'
#   BBR & EPP test: curl -i http://localhost:8081/responses -H 'Content-Type: application/json' --data '{"model":"claude-4","input": "Why is the sky blue"}'
#   Health check: curl -i http://localhost:8081/health
